<div class="marginRight">
  <%= form_with(model: order, local: true) do |form| %>
    <% if order.errors.any? %>
      <div id="error_explanation">
        <h2><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h2>

        <ul>
        <% order.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
        </ul>
      </div>
    <% end %>
    <div class="field">
      <%= form.select(:client_id, [["+New Client", "-1"]] + Client.all.collect {|c| [c.name, c.id]}, {include_blank: _("Select Client")}, {class: "select-client form-control"}) %>
    </div>

    <div class="AddNewClient field" style="display: none;">
        <div class="field">
            <%= form.label :name, "Client Name" %>
            <%= form.text_field :name, class: "form-control" %>
        </div>
        <div class="field">
            <%= form.label :phone, "Phone" %>
            <%= form.text_field :phone, class: "form-control" %>
        </div>
        <div class="field">
            <%= form.label :address, "Address" %>
            <%= form.text_field :address, class: "form-control" %>
        </div>
        <div class="field">
            <%= form.label :city, "City" %>
            <%= form.text_field :city, class: "form-control" %>
        </div>
        <div class="field">
            <%= form.label :country, "Country" %>
            <%= form.text_field :country, class: "form-control" %>
        </div>
    </div>

    <div class="field">
      <%= form.label _('Client Discount') %>
      <%= form.text_field :client_discount, :readonly => true, class: "client_discount form-control", size: 10 %>
    </div>

    <hr>
    <%= form.fields_for :order_products do |builder| %>
        <%= render 'order_product_fields', form: builder %>
    <% end %>

    <div class="mb-3">
      <%= link_to_add_fields _("Add Product"), form, :order_products %>
    </div>

    <div class="field">
      <%= form.label _('Discount on order') %>
      <%= form.number_field :order_discount, class: "discount_on_order form-control" %>
    </div>

    <div class="field">
      <%= form.label _('Grand total') %>
      <%= form.text_field :grand_total, :readonly => true, :class => "order_total form-control" %>
    </div>

    <div class="actions">
      <%= form.submit "#{order.id.nil? ? "Create" : "Update"} Order", :class => 'text-light btn btn-primary' %>
    </div>
  <% end %>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    $(document).on('change', '.select-client', updateClientDiscount);
    $(document).on('click', '.add_fields', updateClientDiscount);
    $(document).on('change', '.product-picker', updateSelectedPrice);
    $(document).on('change', '.product_quantity, .product_price, .product_discount', setSubtotal);
    $(document).on('change', '.product-picker', updateSelectedAmount);
    $(document).on('change', '.product_quantity, .product_discount, .discount_on_order, .product_price', setGrandTotal);
    $(document).on('change', '.select-client', addNewClient);
    $(document).on('after_remove_fields', '.remove_fields', setGrandTotal);

    function updateClientDiscount() {
      $.ajax({
        url: "/discounts/discount_per_kilo",
        data: {client_id: $("#order_client_id").val()},
        type: "GET",
        success: function(data){
          $(".client_discount").val(data['discount_per_kilo'] + '%');
        }
      })
    };

    function updateSelectedPrice() {
      var jquery_prod_picker = $(this);
      $.ajax({ 
        url: "/products/price",
        data: { id: $(this).val()  },
        type: "GET",
        success: function(data){
          jquery_prod_picker.parents(".nested-fields").find('.product_price').val(data['price']).trigger('change');
        }
      })
    };

    function addNewClient() {
      var value = $(this).val() == "-1"
      $(this).parents(".marginRight").find(".AddNewClient").toggle(value)
    };
    
    function setSubtotal() {
      var pQuantity = $(this).parents('.nested-fields').find('.product_quantity').val();
      var pPrice = $(this).parents('.nested-fields').find('.product_price').val();
      var pDiscount = $(this).parents('.nested-fields').find('.product_discount').val();
      var quantityPlusPrice = pQuantity * pPrice;
      var discountTosubtract = pQuantity * pDiscount;
      var pSubtotal = quantityPlusPrice - discountTosubtract

      $(this).parents('.nested-fields').find('.product_subtotal').val(pSubtotal).trigger('change');
    };
  
    function setGrandTotal() {
      var grand_total = 0
      var discount_on_order = $('.discount_on_order').val()
      $('.nested-fields').each(function() {   
        var destroy = $(this).find('.remove').val()   
        if(destroy != "1"){
          var subtotal = $(this).find('.product_subtotal').val() || 0
            grand_total += parseFloat(subtotal);  
        }
      })
      $(this).parents('.marginRight').find('.order_total').val(grand_total - discount_on_order).trigger('change')
    };
     
    function updateSelectedAmount() {
      $.ajax({ 
        url: "<%= current_amount_left_path %>",
        data: { product_id: $(this).val() },
        type: "GET",
        success: function(data){
          $('.current_amount_field').val(data['current_amount_left']);
        }
      })
    };
    $(".product-picker").each(updateSelectedAmount);
  });
</script>