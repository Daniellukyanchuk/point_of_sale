

<p id="notice"><%= notice %></p>

<h1><%= _('Client Purchase Report') %></h1>

<%# keyword and product-selector %>

<div class="w-100 d-inline-block mb-5">
  <div class="d-inline-flex w-50 px-0 mb-4" style="height: 2.5rem;">
    <div class="col-6 px-0">
      <%= form_tag reports_purchase_report_path, :method => 'get', :class => "form-group" do %>  
      <%= text_field_tag :search, params[:search], :placeholder => _("enter keyword(s)"), :class => "form-control" %> 
    </div>
    <div class="drop-down drop-down-sm input-group input-group-prepend px-0">  
      <span class="input-group-text rounded-0 col-2">
          <%= _("AND") %>
      </span>
      <button type="button" class="col btn btn-warning dropdown-toggle dropdown-toggle" data-toggle="dropdown">  
        <%= _("Select Products") %>  
      </button>      
      <div class="dropdown-menu col-10">
        <% options = Product.all.collect{ |p| [p.product_name, p.id] } %>
        <% options = [["Show All", nil]] + options %>
        <%= select_tag 'product_select[]', options_for_select(options, params[:product_select]), :multiple => :multiple, :size => 10, :class => "form-control select-item" %>
      </div>       
    </div>
    
  </div>

  <div class="w-50 d-inline-flex pl-0 mb-4" style="height: 2.5rem;">
    <div class="input-group-prepend input-group rounded-left">

      <span class="input-group-text justify-content-center col">
        <%= _("from:") %> <input type="text" class="datepicker pl-2" id="from" name="from_date" 
                autocomplete = 'off' value = "<%= params[:from_date] %>">
      </span>

      <span class="input-group-text justify-content-center col">
        <%= _("to:") %> <input type="text" class="datepicker pl-2" id="to" name="to_date" 
                autocomplete = 'off' value = "<%= params[:to_date] %>">
      </span>

      <div class="input-group-append">
        <%= button_tag(type: "submit", class: "btn btn-warning") do %>
        <%= _("Search") %> <i class="fa-solid fa-magnifying-glass"></i>
        <% end %>
      </div>
    </div>
    
    <% end %>
  </div>
</div>

<table>
  <thead>
    <tr>
    <th class="align_left"><%= sortable "client_id", _("Id") %></th>
    <th class="align_left"><%= sortable "name", _("Client Name") %></th>
    <th><%= sortable "orders_placed", _("Orders Placed") %></th>
    <th><%= sortable "total_spent", _("Total Spent") %></th>
    <th><%= sortable "avg_spent", _("Avg. Spent") %></th>
    <th colspan="4"></th>
    </tr>
  </thead>

  <tbody>
    <% @client_reports.each do |c_report| %> 
      <tr>     
        <td><%= c_report["client_id"] %></td>
        <td><%= c_report["name"] %></td>
        <td class="align_center"><%= number_with_precision(c_report["orders_placed"], precision: 2, delimiter: ' ') %></td>
        <td class="align_right"><%= number_with_precision(c_report["total_spent"], precision: 2, delimiter: ' ') %></td>
        <td class="align_right"><%= number_with_precision(c_report["avg_spent"], precision: 2, delimiter: ' ') %></td>
      </tr>
      <% end %>
  </tbody>
</table>

<script type="text/javascript">

  $( function() {
      var dateFormat = "mm/dd/yy",
            from = $( "#from" ).datepicker({
            changeMonth: true,
            numberOfMonths: 1
          })
          .on( "change", function() {
            to.datepicker( "option", "minDate", getDate( this ) );
          }),
        to = $( "#to" ).datepicker({
          changeMonth: true,
          numberOfMonths: 1
        })
        .on( "change", function() {
          from.datepicker( "option", "maxDate", getDate( this ) );
        });
  
      function getDate( element ) {
        var date;
        try {
          date = $.datepicker.parseDate( dateFormat, element.value );
        } catch( error ) {
          date = null;
        }
  
        return date;
      }
    } );

$(".chosen-select").chosen({
  no_results_text: "Oops, nothing found!"
})

</script>
