<div class="marginRight">
    <%= form_with(model: purchase, local: true) do |form| %>
      <% if purchase.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(purchase.errors.count, "error") %> prohibited this purchase from being saved:</h2>

          <ul>
          <% purchase.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
          </ul>
        </div>
      <% end %>
      <div class="field">
        <%= form.select(:supplier_id, [[_("+New Supplier"), "-1"]] + Supplier.all.collect {|s| [s.suppliers_name, s.id]}, {include_blank: _("Select Supplier")}, {class: "select-supplier form-control"}) %>
      </div>

      <div class="AddNewSupplier field" style="display: none;">
        <div class="field">
          <%= form.label :suppliers_name, "Supplier Name" %>
          <%= form.text_field :suppliers_name, class: "form-control" %>
        </div>
        <div class="field">
          <%= form.label :city, "City" %>
          <%= form.text_field :city, class: "form-control" %>
        </div>
        <div class="field">
          <%= form.label :country, "Country" %>
          <%= form.text_field :country, class: "form-control" %>
        </div>
        <div class="field">
          <%= form.label :address, "Address" %>
          <%= form.text_field :address, class: "form-control" %>
        </div>
        <div class="field">
          <%= form.label :phone_number, "Phone Number" %>
          <%= form.number_field :phone_number, class: "form-control" %>
        </div>
      </div>

      <hr>
     
      <%= form.fields_for :purchase_products do |builder| %>
          <%= render 'purchase_product_fields', form: builder %>
      <% end %>
      
      <div class="mb-3">
        <%= link_to_add_fields _("Add Product"), form, :purchase_products %>
      </div>

      <div class="field">
        <%= form.label _('Date of order') %>
        <%= text_field_tag 'date_of_order', params[:date_of_the_order], :class => "datepicker form-control", :autocomplete => "off", :placeholder => _("Pick a date") %>
      </div>

      <div class="field">
        <%= form.label _('Estimated total') %>
        <%= form.text_field :estimated_total, class: "est_total", :readonly => true, :class => "est_total form-control" %>
      </div>

      <div class="field">
        <%= form.label _('Actual total') %>
        <%= form.text_field :actual_total, class: "act_total", :readonly => true, :class => "act_total form-control" %>
      </div>

      <div class="field">
        <%= form.label _('Expected date of delivery') %>
        <%= text_field_tag 'date_of_delivery', params[:expected_date_of_delivery], :class => "datepicker form-control", :autocomplete => "off", :placeholder => _("Pick a date") %>
      </div>

      <div class="actions">
        <%= form.submit "#{purchase.id.nil? ? "Create" : "Update"} Purchase", :class => 'text-light btn btn-primary' %>
      </div>

      <div action="/html/tags/html_form_tag_action.cfm" method="post">
        <div class="field">
          <textarea class="form-control">
          </textarea>
        </div>
      </div>
    <% end %>
</div>


<script type="text/javascript">
    $(document).on('change', '.select-supplier', function() {
        var value = $(this).val() == "-1"
        $(this).parents(".marginRight").find(".AddNewSupplier").toggle(value)
    });

    $(document).ready(function() {
      function updateSelectedPrice(){
        var jquery_prod_picker = $(this);
        $.ajax({ 
            url: "/products/price",
            data: { id: $(this).val()  },
            type: "GET",
            success: function(data){
                jquery_prod_picker.parents(".nested-fields").find('.sale-price-field').val(data['price']);
            }
        });
      }
      $(document).on('change', '.product-picker', updateSelectedPrice);
      $(".product-picker").each(updateSelectedPrice);
    });

    $(document.body).on('keyup', '.est_quantity, .est_price', function(){
      var eQuantity = $(this).parents('.nested-fields').find('.est_quantity').val();
      var ePrice = $(this).parents('.nested-fields').find('.est_price').val();
      var cmpSubtotal = eQuantity * ePrice;
      $(this).parents('.nested-fields').find('.est_subtotal').val(cmpSubtotal).trigger('change');    
    });

    $(document.body).on('keyup', '.act_quantity, .act_price', function(){
      var aQuantity = $(this).parents('.nested-fields').find('.act_quantity').val();
      var aPrice = $(this).parents('.nested-fields').find('.act_price').val();
      var cmpSubtotal = aQuantity * aPrice;
      $(this).parents('.nested-fields').find('.act_subtotal').val(cmpSubtotal).trigger('change');    
    });  

    $(document).on('change', '.est_subtotal', function() {     
        var sum = 0
        $(this).parents('.marginRight').find('.est_subtotal').each(function() {
          sum += parseFloat($(this).val());
        });
     
      $(this).parents('.marginRight').find('.est_total').val(sum)
    });

    $(document.body).on('change', '.act_subtotal', function() {
        var total = 0
        $('.act_subtotal').each(function() {
          total += parseFloat($(this).val());
        });
      
      $('.act_total').val(total)
    });

    $(document).on('change', '.est_subtotal', function() {
      var est_total = 0
      $(this).parents('.marginRight').find('.est_subtotal').each(function() {
        est_total += parseFloat($(this).val());
      })
      $(this).parents('.marginRight').find('.est_total').val(est_total).trigger('change')
    });

    $(document).on('change', '.act_subtotal', function() {
      var act_total = 0
      $(this).parents('.marginRight').find('.act_subtotal').each(function() {
        act_total += parseFloat($(this).val());
      })
      $(this).parents('.marginRight').find('.act_total').val(act_total).trigger('change')
    });

    $( function() {
      $( ".datepicker" ).datepicker({ dateFormat: 'dd-mm-yy'});
    });
</script> 

